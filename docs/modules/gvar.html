<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>gvar.py — MPTB_vshell</title>
    <link rel="stylesheet" href="../style.css">
</head>
<body>
<header>
    <h1>gvar.py</h1>
    <nav><a href="../index.html">Inicio</a> · <a href="modules.html">Módulos</a></nav>
</header>
<main>
    <section class="card">
        <h2>Resumen</h2>
        <p><code>modules/gvar.py</code> centraliza la configuración global del proyecto y la inicialización de objetos compartidos (colas, pool de hilos, cliente de IA y el bot de Telegram).</p>
    </section>

    <section class="card">
        <h2>Variables y componentes importantes</h2>
        <ul>
            <li><code>TOKEN</code>, <code>API_HASH</code>, <code>OPEN_AI_API_KEY</code>, <code>API_ID</code>: cargadas desde variables de entorno.</li>
            <li><code>PROXY</code>: cadena con proxy por defecto (<code>http://127.0.0.1:8118</code>).</li>
            <li><code>actions</code>: instancia de <code>MessageQueue</code> (cola principal de mensajes).</li>
            <li><code>runner</code>: instancia de <code>Pool</code> (pool de hilos para ejecutar tareas).</li>
            <li><code>model</code>: cliente de OpenAI inicializado si <code>OPEN_AI_API_KEY</code> está presente.</li>
            <li><code>commands</code>: diccionario que mapea cadenas de comando a funciones en <code>modules/core/commands.py</code>.</li>
            <li><code>COMMANDS</code>: lista de nombres de comandos usados por <code>brain.py</code>.</li>
            <li><code>bot</code>: instancia de <code>Application</code> de <code>python-telegram-bot</code>, creada con <code>TOKEN</code> y luego se ejecuta el <code>runner.run()</code>.</li>
        </ul>
    </section>

    <section class="card">
        <h2>Notas sobre el código actual</h2>
        <ul>
            <li>Conviene validar que las variables de entorno existan antes de intentar convertirlas (<code>int(os.getenv("API_ID"))</code> lanzará si no está definida).</li>
            <li>Se inicializa <code>model</code> con <code>openai.OpenAI(api_key=..., http_client=...)</code> usando <code>httpx.Client(proxy=PROXY)</code>. Asegurarse de que la librería y la API sean compatibles (la llamada <code>model.responses.create</code> en <code>chatgpt.py</code> asume la API nueva).</li>
            <li>El diccionario <code>commands</code> referencia funciones que deben estar importadas/definidas en el momento de la importación (ya lo hace con <code>from modules.core.commands import *</code>).</li>
            <li>Se llama a <code>runner.run()</code> para arrancar el pool (aunque en <code>Pool.__init__</code> ya se lanza un hilo con <code>self.run()</code> — revisar duplicidad).</li>
        </ul>
    </section>

    <section class="card">
        <h2>Mejoras y recomendaciones</h2>
        <ul>
            <li>Agregar validaciones y valores por defecto seguros antes de parsear variables de entorno.</li>
            <li>Proteger claves y no imprimir objetos sensibles en producción (actualmente el script hace <code>print(model)</code>).</li>
            <li>Separar la inicialización en una función <code>init_globals()</code> para facilitar tests y reuso.</li>
        </ul>
    </section>

    <footer>
        <p>Archivo: <code>modules/gvar.py</code></p>
    </footer>
</main>
</body>
</html>