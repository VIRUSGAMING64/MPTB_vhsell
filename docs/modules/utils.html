<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>utils.py — MPTB_vhsell</title>
    <link rel="stylesheet" href="../style.css">
</head>
<body>
<header>
    <h1>utils.py</h1>
    <nav><a href="../index.html">Inicio</a> · <a href="modules.html">Módulos</a></nav>
</header>
<main>
    <section class="card">
        <h2>Resumen</h2>
        <p>Contiene utilidades comunes usadas por el bot: gestión del loop de asyncio, helper para progreso, detección de tipo de medios y ejecución de coroutines en el event loop compartido.</p>
    </section>

    <section class="card">
        <h3><code>loop</code> y <code>loop_runner()</code></h3>
        <p>Se crea un nuevo event loop global con <code>asyncio.new_event_loop()</code> y se lanza un hilo daemon que lo ejecuta indefinidamente. Esto permite ejecutar coroutines desde hilos no-async usando <code>asyncio.run_coroutine_threadsafe</code> (vía <code>await_exec</code>).</p>

        <h3><code>await_exec(func, args)</code></h3>
        <p>Helper que planifica la ejecución de una coroutine en el loop global mediante <code>asyncio.run_coroutine_threadsafe(func(*args), loop)</code>. Es usada para enviar respuestas al usuario desde código no-async.</p>
    </section>

    <section class="card">
        <h3><code>progress(count, total, base="", speed=None, label="Downloading")</code></h3>
        <p>Genera una barra de progreso textual usando emojis (importados de <code>pyrogram.emoji</code>). Devuelve un texto con porcentaje y barra visual.</p>

        <h3><code>GetMedia(message)</code></h3>
        <p>Detecta qué tipo de media contiene el mensaje y devuelve una bitmask usando constantes de <code>modules/core/enums.py</code> (VIDEO, AUDIO, DOCUMENT, PHOTO, VOICE).</p>

        <h3><code>getfullpath(args: str)</code></h3>
        <p>Actualmente contiene un <code>assert 0</code> — es un placeholder que debe implementarse para resolver rutas o interpretar argumentos de comando <code>/upload</code>.</p>
    </section>

    <section class="card">
        <h2>Mejoras recomendadas</h2>
        <ul>
            <li>Implementar <code>getfullpath</code> con validación de paths y seguridad (evitar path traversal).</li>
            <li>Manejo de excepciones alrededor de <code>await_exec</code> y validaciones adicionales sobre <code>message</code>.</li>
            <li>Considerar usar un pool de loop/threads si la carga es alta y evitar variables globales compartidas sin sincronización.</li>
        </ul>
    </section>

    <footer>
        <p>Archivo: <code>modules/utils.py</code></p>
    </footer>
</main>
</body>
</html>